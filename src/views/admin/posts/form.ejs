<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title><%= isEdit ? 'Editar Post' : 'Novo Post' %> - Admin</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.2/font/bootstrap-icons.css" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <style>
    :root { --primary: #3ba4ff; }
    * { font-family: 'Inter', sans-serif; }
    body { background: #f1f5f9; font-size: 13px; }
    .navbar { background: #fff; box-shadow: 0 1px 3px rgba(0,0,0,0.1); padding: 0.5rem 0; }
    .navbar-brand { font-weight: 700; color: var(--primary) !important; font-size: 1rem; }
    .card { border: none; border-radius: 10px; box-shadow: 0 1px 3px rgba(0,0,0,0.08); }
    .card-header { background: #fff; border-bottom: 1px solid #e2e8f0; font-weight: 600; padding: 0.75rem 1rem; font-size: 0.85rem; }
    .form-label { font-weight: 500; color: #374151; margin-bottom: 4px; font-size: 0.8rem; }
    .form-control, .form-select { border-radius: 6px; border: 1px solid #d1d5db; padding: 8px 12px; font-size: 0.85rem; }
    .form-control-lg { padding: 10px 14px; font-size: 1rem; }
    .form-control:focus, .form-select:focus { border-color: var(--primary); box-shadow: 0 0 0 2px rgba(59,164,255,0.15); }
    .btn { font-size: 0.85rem; padding: 6px 14px; }
    .btn-primary { background: var(--primary); border: none; border-radius: 6px; font-weight: 500; }
    .btn-primary:hover { background: #2b8ce6; }
    .btn-lg { padding: 10px 18px; font-size: 0.9rem; }
    .btn-outline-secondary { border-radius: 6px; }
    .btn-sm { font-size: 0.75rem; padding: 4px 10px; }
    .ck-editor__editable { min-height: 350px !important; font-size: 0.9rem; }
    .img-preview { max-height: 120px; object-fit: cover; border-radius: 6px; }
    .text-muted { font-size: 0.75rem; }
    .form-check-label { font-size: 0.85rem; }
    .input-group-text { font-size: 0.8rem; padding: 8px 10px; }
    small { font-size: 0.7rem; }
    .mb-3 { margin-bottom: 0.75rem !important; }
    .mb-4 { margin-bottom: 1rem !important; }
    .g-4 { gap: 1rem !important; }
    .card-body { padding: 1rem; }
    
    /* For√ßar layout lado a lado */
    .row.g-4 { flex-wrap: nowrap; }
    @media (max-width: 991px) {
      .row.g-4 { flex-wrap: wrap; }
    }
    
    /* Estilos para o modal de galeria */
    .media-gallery { display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px; max-height: 400px; overflow-y: auto; }
    .media-item { cursor: pointer; border: 2px solid transparent; border-radius: 8px; overflow: hidden; transition: all 0.2s; }
    .media-item:hover { border-color: var(--primary); transform: scale(1.02); }
    .media-item.selected { border-color: var(--primary); box-shadow: 0 0 0 3px rgba(59,164,255,0.3); }
    .media-item img { width: 100%; height: 100px; object-fit: cover; }
    .upload-zone { border: 2px dashed #d1d5db; border-radius: 8px; padding: 20px; text-align: center; cursor: pointer; transition: all 0.2s; }
    .upload-zone:hover { border-color: var(--primary); background: rgba(59,164,255,0.05); }
    .upload-zone.dragover { border-color: var(--primary); background: rgba(59,164,255,0.1); }
  </style>
</head>
<body>
  <!-- Navbar -->
  <nav class="navbar navbar-expand-lg mb-3">
    <div class="container-fluid px-3">
      <a class="navbar-brand" href="/admin"><i class="bi bi-lightning-charge"></i> Portal Admin</a>
      <div class="d-flex align-items-center gap-2">
        <a href="/admin/posts" class="btn btn-outline-secondary btn-sm">
          <i class="bi bi-arrow-left me-1"></i>Voltar
        </a>
        <a href="/" target="_blank" class="btn btn-outline-secondary btn-sm">
          <i class="bi bi-box-arrow-up-right me-1"></i>Ver Site
        </a>
      </div>
    </div>
  </nav>

  <div class="container-fluid px-3 pb-4">
    <form id="postForm" action="<%= isEdit ? '/admin/posts/' + post.id : '/admin/posts' %>" method="POST" enctype="multipart/form-data">
      <div class="row g-4">
        <!-- Conte√∫do Principal -->
        <div class="col-md-8">
          <!-- T√≠tulo -->
          <div class="card mb-3">
            <div class="card-body py-3">
              <div class="mb-2">
                <label class="form-label">T√≠tulo <span class="text-danger">*</span></label>
                <input type="text" name="title" class="form-control form-control-lg" 
                       value="<%= post ? post.title : '' %>" required 
                       placeholder="Digite o t√≠tulo do post" style="font-weight: 600;">
              </div>
              <div>
                <label class="form-label">Subt√≠tulo</label>
                <input type="text" name="subtitle" class="form-control" 
                       value="<%= post ? (post.subtitle || '') : '' %>" 
                       placeholder="Subt√≠tulo ou resumo curto (opcional)">
              </div>
            </div>
          </div>

          <!-- Editor de Conte√∫do -->
          <div class="card mb-3">
            <div class="card-header d-flex justify-content-between align-items-center">
              <span><i class="bi bi-pencil-square me-2"></i>Conte√∫do</span>
              <button type="button" class="btn btn-outline-primary btn-sm" onclick="openMediaModal()">
                <i class="bi bi-image me-1"></i>Inserir Imagem
              </button>
            </div>
            <div class="card-body">
              <textarea name="content" id="editor"><%= post ? post.content : '' %></textarea>
              <input type="hidden" name="content_backup" id="contentBackup">
            </div>
          </div>

          <!-- Embed de Redes Sociais -->
          <div class="card mb-3">
            <div class="card-header" data-bs-toggle="collapse" data-bs-target="#embedSection" style="cursor: pointer;">
              <i class="bi bi-play-circle me-2"></i>Embed de M√≠dia <small class="text-muted ms-2">(YouTube, Instagram, Facebook)</small>
              <i class="bi bi-chevron-down float-end"></i>
            </div>
            <div class="collapse" id="embedSection">
              <div class="card-body">
                <div class="mb-2">
                  <label class="form-label">C√≥digo Embed</label>
                  <textarea name="embed_code" class="form-control" rows="4" 
                            placeholder="Cole aqui o c√≥digo embed do YouTube, Instagram, Facebook ou TikTok..."><%= post ? (post.embed_code || '') : '' %></textarea>
                  <small class="text-muted">
                    <i class="bi bi-info-circle me-1"></i>
                    Cole o c√≥digo de incorpora√ß√£o (embed) da publica√ß√£o. O embed ser√° exibido ap√≥s o conte√∫do do post.
                  </small>
                </div>
                <div class="embed-help mt-3 p-2 bg-light rounded" style="font-size: 0.75rem;">
                  <strong>Como obter o c√≥digo embed:</strong>
                  <ul class="mb-0 mt-1 ps-3">
                    <li><strong>YouTube:</strong> Clique em "Compartilhar" ‚Üí "Incorporar" ‚Üí Copie o c√≥digo</li>
                    <li><strong>Instagram:</strong> Clique nos 3 pontos ‚Üí "Incorporar" ‚Üí Copie o c√≥digo</li>
                    <li><strong>Facebook:</strong> Clique nos 3 pontos ‚Üí "Incorporar" ‚Üí Copie o c√≥digo</li>
                    <li><strong>TikTok:</strong> Clique em "Compartilhar" ‚Üí "Incorporar" ‚Üí Copie o c√≥digo</li>
                  </ul>
                </div>
              </div>
            </div>
          </div>

          <!-- SEO (Colaps√°vel) -->
          <div class="card">
            <div class="card-header" data-bs-toggle="collapse" data-bs-target="#seoSection" style="cursor: pointer;">
              <i class="bi bi-search me-2"></i>SEO <small class="text-muted ms-2">(opcional)</small>
              <i class="bi bi-chevron-down float-end"></i>
            </div>
            <div class="collapse" id="seoSection">
              <div class="card-body">
                <div class="mb-2">
                  <label class="form-label">Slug (URL)</label>
                  <div class="input-group">
                    <span class="input-group-text">/noticia/</span>
                    <input type="text" name="slug" class="form-control" 
                           value="<%= post ? post.slug : '' %>" placeholder="url-amigavel">
                  </div>
                  <small class="text-muted">Deixe em branco para gerar automaticamente</small>
                </div>
                <div class="mb-2">
                  <label class="form-label">Meta T√≠tulo</label>
                  <input type="text" name="meta_title" class="form-control" 
                         value="<%= post ? (post.meta_title || '') : '' %>" 
                         maxlength="70" placeholder="T√≠tulo para SEO (m√°x. 70 caracteres)">
                </div>
                <div>
                  <label class="form-label">Meta Descri√ß√£o</label>
                  <textarea name="meta_description" class="form-control" rows="2" 
                            maxlength="160" placeholder="Descri√ß√£o para SEO (m√°x. 160 caracteres)"><%= post ? (post.meta_description || '') : '' %></textarea>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Sidebar -->
        <div class="col-md-4">
          <!-- Publicar -->
          <div class="card mb-3">
            <div class="card-header">
              <i class="bi bi-send me-2"></i>Publicar
            </div>
            <div class="card-body">
              <div class="mb-2">
                <label class="form-label">Status</label>
                <select name="status" class="form-select">
                  <option value="draft" <%= post && post.status === 'draft' ? 'selected' : '' %>>üìù Rascunho</option>
                  <option value="published" <%= post && post.status === 'published' ? 'selected' : '' %>>‚úÖ Publicado</option>
                  <option value="scheduled" <%= post && post.status === 'scheduled' ? 'selected' : '' %>>üìÖ Agendado</option>
                </select>
              </div>
              
              <div class="mb-2">
                <label class="form-label">Agendar para</label>
                <input type="datetime-local" name="scheduled_at" class="form-control" 
                       value="<%= post && post.scheduled_at ? new Date(post.scheduled_at).toISOString().slice(0,16) : '' %>">
              </div>
              
              <div class="form-check mb-3">
                <input type="checkbox" name="featured" class="form-check-input" id="featured" <%= post && post.featured ? 'checked' : '' %>>
                <label class="form-check-label" for="featured">
                  <i class="bi bi-star-fill text-warning me-1"></i>Destaque na Home
                </label>
              </div>
              
              <div class="d-grid gap-2">
                <button type="submit" class="btn btn-primary btn-lg">
                  <i class="bi bi-check-lg me-1"></i><%= isEdit ? 'Atualizar Post' : 'Publicar Post' %>
                </button>
                <% if (isEdit) { %>
                  <a href="/noticia/<%= post.slug %>" target="_blank" class="btn btn-outline-secondary">
                    <i class="bi bi-eye me-1"></i>Visualizar
                  </a>
                <% } %>
              </div>
            </div>
          </div>

          <!-- Categoria -->
          <div class="card mb-3">
            <div class="card-header">
              <i class="bi bi-folder me-2"></i>Categoria
            </div>
            <div class="card-body py-2">
              <select name="category_id" class="form-select">
                <option value="">Sem categoria</option>
                <% categories.forEach(cat => { %>
                  <option value="<%= cat.id %>" <%= post && post.category_id == cat.id ? 'selected' : '' %>><%= cat.name %></option>
                <% }) %>
              </select>
            </div>
          </div>

          <!-- Tags -->
          <div class="card mb-3">
            <div class="card-header">
              <i class="bi bi-tags me-2"></i>Tags
            </div>
            <div class="card-body py-2">
              <input type="text" name="tags" class="form-control" 
                     value="<%= post && post.tags ? (Array.isArray(post.tags) ? post.tags.join(', ') : post.tags) : '' %>" 
                     placeholder="tag1, tag2, tag3">
              <small class="text-muted">Separe por v√≠rgula</small>
            </div>
          </div>

          <!-- Imagem Destacada -->
          <div class="card">
            <div class="card-header">
              <i class="bi bi-image me-2"></i>Imagem Destacada
            </div>
            <div class="card-body py-2">
              <% if (post && post.featured_image) { %>
                <div class="mb-2">
                  <img src="<%= post.featured_image %>" alt="" class="img-fluid img-preview w-100">
                </div>
              <% } %>
              <input type="file" name="featured_image" class="form-control" accept="image/*" id="imageInput">
              <div id="imagePreview" class="mt-2"></div>
              <small class="text-muted">JPG, PNG, GIF, WebP (m√°x. 10MB)</small>
            </div>
          </div>
        </div>
      </div>
    </form>
  </div>

  <!-- Modal de M√≠dia para inserir imagem no conte√∫do -->
  <div class="modal fade" id="mediaModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" style="font-size: 1rem;"><i class="bi bi-images me-2"></i>Inserir Imagem no Conte√∫do</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <!-- Tabs -->
          <ul class="nav nav-tabs mb-3" role="tablist">
            <li class="nav-item">
              <button class="nav-link active" data-bs-toggle="tab" data-bs-target="#uploadTab" style="font-size: 0.85rem;">
                <i class="bi bi-cloud-upload me-1"></i>Upload
              </button>
            </li>
            <li class="nav-item">
              <button class="nav-link" data-bs-toggle="tab" data-bs-target="#galleryTab" style="font-size: 0.85rem;">
                <i class="bi bi-grid me-1"></i>Galeria
              </button>
            </li>
            <li class="nav-item">
              <button class="nav-link" data-bs-toggle="tab" data-bs-target="#urlTab" style="font-size: 0.85rem;">
                <i class="bi bi-link-45deg me-1"></i>URL Externa
              </button>
            </li>
          </ul>
          
          <div class="tab-content">
            <!-- Upload Tab -->
            <div class="tab-pane fade show active" id="uploadTab">
              <div class="upload-zone" id="uploadZone" onclick="document.getElementById('mediaUploadInput').click()">
                <i class="bi bi-cloud-arrow-up" style="font-size: 2rem; color: #6b7280;"></i>
                <p class="mb-1 mt-2" style="font-size: 0.9rem;">Clique ou arraste uma imagem aqui</p>
                <small class="text-muted">JPG, PNG, GIF, WebP (m√°x. 10MB)</small>
              </div>
              <input type="file" id="mediaUploadInput" accept="image/*" style="display: none;">
              <div id="uploadPreview" class="mt-3 text-center"></div>
            </div>
            
            <!-- Gallery Tab -->
            <div class="tab-pane fade" id="galleryTab">
              <div id="mediaGallery" class="media-gallery">
                <div class="text-center py-4 w-100">
                  <div class="spinner-border spinner-border-sm text-primary" role="status"></div>
                  <p class="mt-2 mb-0" style="font-size: 0.85rem;">Carregando imagens...</p>
                </div>
              </div>
            </div>
            
            <!-- URL Tab -->
            <div class="tab-pane fade" id="urlTab">
              <div class="mb-3">
                <label class="form-label">URL da Imagem</label>
                <input type="url" id="externalImageUrl" class="form-control" placeholder="https://exemplo.com/imagem.jpg">
              </div>
              <div id="urlPreview" class="text-center"></div>
            </div>
          </div>
          
          <!-- Op√ß√µes da imagem -->
          <div id="imageOptions" class="mt-3 p-3 bg-light rounded" style="display: none;">
            <div class="row g-2">
              <div class="col-md-6">
                <label class="form-label">Texto alternativo (alt)</label>
                <input type="text" id="imageAlt" class="form-control" placeholder="Descri√ß√£o da imagem">
              </div>
              <div class="col-md-6">
                <label class="form-label">Alinhamento</label>
                <select id="imageAlign" class="form-select">
                  <option value="">Padr√£o</option>
                  <option value="left">Esquerda</option>
                  <option value="center">Centro</option>
                  <option value="right">Direita</option>
                </select>
              </div>
            </div>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Cancelar</button>
          <button type="button" class="btn btn-primary" id="insertImageBtn" disabled onclick="insertImageToEditor()">
            <i class="bi bi-plus-lg me-1"></i>Inserir Imagem
          </button>
        </div>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://cdn.ckeditor.com/ckeditor5/40.1.0/classic/ckeditor.js"></script>
  <script>
    let editorInstance;
    let selectedImageUrl = '';
    let mediaModal;
    
    // Inicializar CKEditor com suporte a imagens
    ClassicEditor
      .create(document.querySelector('#editor'), {
        toolbar: ['heading', '|', 'bold', 'italic', 'link', '|', 'bulletedList', 'numberedList', '|', 'blockQuote', 'insertTable', '|', 'undo', 'redo'],
        placeholder: 'Escreva o conte√∫do do seu post aqui...'
      })
      .then(editor => {
        editorInstance = editor;
      })
      .catch(error => console.error(error));

    // Inicializar modal
    document.addEventListener('DOMContentLoaded', function() {
      mediaModal = new bootstrap.Modal(document.getElementById('mediaModal'));
    });

    // Abrir modal de m√≠dia
    function openMediaModal() {
      selectedImageUrl = '';
      document.getElementById('insertImageBtn').disabled = true;
      document.getElementById('imageOptions').style.display = 'none';
      document.getElementById('uploadPreview').innerHTML = '';
      document.getElementById('urlPreview').innerHTML = '';
      document.getElementById('externalImageUrl').value = '';
      document.getElementById('imageAlt').value = '';
      document.getElementById('imageAlign').value = '';
      
      // Carregar galeria
      loadMediaGallery();
      
      mediaModal.show();
    }

    // Carregar galeria de m√≠dia
    async function loadMediaGallery() {
      const gallery = document.getElementById('mediaGallery');
      try {
        const response = await fetch('/admin/media/browse');
        const data = await response.json();
        
        if (data.medias && data.medias.length > 0) {
          gallery.innerHTML = data.medias.map(item => `
            <div class="media-item" onclick="selectGalleryImage('${item.url}', this)">
              <img src="${item.url}" alt="${item.alt_text || ''}">
            </div>
          `).join('');
        } else {
          gallery.innerHTML = '<div class="text-center py-4 w-100"><p class="text-muted mb-0" style="font-size: 0.85rem;">Nenhuma imagem na galeria</p></div>';
        }
      } catch (error) {
        gallery.innerHTML = '<div class="text-center py-4 w-100"><p class="text-muted mb-0" style="font-size: 0.85rem;">Erro ao carregar galeria</p></div>';
      }
    }

    // Selecionar imagem da galeria
    function selectGalleryImage(url, element) {
      document.querySelectorAll('.media-item').forEach(el => el.classList.remove('selected'));
      element.classList.add('selected');
      selectedImageUrl = url;
      document.getElementById('insertImageBtn').disabled = false;
      document.getElementById('imageOptions').style.display = 'block';
    }

    // Upload de imagem
    document.getElementById('mediaUploadInput').addEventListener('change', async function(e) {
      const file = e.target.files[0];
      if (!file) return;
      
      const formData = new FormData();
      formData.append('file', file);
      
      const preview = document.getElementById('uploadPreview');
      preview.innerHTML = '<div class="spinner-border spinner-border-sm text-primary"></div> Enviando...';
      
      try {
        const response = await fetch('/admin/media/upload', {
          method: 'POST',
          body: formData
        });
        const data = await response.json();
        
        if (data.success && data.media) {
          selectedImageUrl = data.media.url;
          preview.innerHTML = `<img src="${data.media.url}" style="max-height: 150px; border-radius: 8px;">`;
          document.getElementById('insertImageBtn').disabled = false;
          document.getElementById('imageOptions').style.display = 'block';
        } else {
          preview.innerHTML = '<p class="text-danger">Erro no upload: ' + (data.message || 'Erro desconhecido') + '</p>';
        }
      } catch (error) {
        preview.innerHTML = '<p class="text-danger">Erro no upload</p>';
      }
    });

    // Drag and drop
    const uploadZone = document.getElementById('uploadZone');
    uploadZone.addEventListener('dragover', (e) => { e.preventDefault(); uploadZone.classList.add('dragover'); });
    uploadZone.addEventListener('dragleave', () => uploadZone.classList.remove('dragover'));
    uploadZone.addEventListener('drop', (e) => {
      e.preventDefault();
      uploadZone.classList.remove('dragover');
      const file = e.dataTransfer.files[0];
      if (file && file.type.startsWith('image/')) {
        const input = document.getElementById('mediaUploadInput');
        const dt = new DataTransfer();
        dt.items.add(file);
        input.files = dt.files;
        input.dispatchEvent(new Event('change'));
      }
    });

    // URL externa
    document.getElementById('externalImageUrl').addEventListener('input', function() {
      const url = this.value.trim();
      const preview = document.getElementById('urlPreview');
      
      if (url && (url.startsWith('http://') || url.startsWith('https://'))) {
        preview.innerHTML = `<img src="${url}" style="max-height: 150px; border-radius: 8px;" onerror="this.parentElement.innerHTML='<p class=\\'text-danger\\'>Imagem n√£o encontrada</p>'">`;
        selectedImageUrl = url;
        document.getElementById('insertImageBtn').disabled = false;
        document.getElementById('imageOptions').style.display = 'block';
      } else {
        preview.innerHTML = '';
        selectedImageUrl = '';
        document.getElementById('insertImageBtn').disabled = true;
        document.getElementById('imageOptions').style.display = 'none';
      }
    });

    // Inserir imagem no editor
    function insertImageToEditor() {
      if (!selectedImageUrl || !editorInstance) return;
      
      const alt = document.getElementById('imageAlt').value || '';
      const align = document.getElementById('imageAlign').value;
      
      let style = '';
      if (align === 'center') style = 'display: block; margin: 0 auto;';
      else if (align === 'left') style = 'float: left; margin-right: 15px;';
      else if (align === 'right') style = 'float: right; margin-left: 15px;';
      
      const imgHtml = `<img src="${selectedImageUrl}" alt="${alt}" style="${style} max-width: 100%; height: auto; margin-bottom: 15px;">`;
      
      const viewFragment = editorInstance.data.processor.toView(imgHtml);
      const modelFragment = editorInstance.data.toModel(viewFragment);
      editorInstance.model.insertContent(modelFragment);
      
      mediaModal.hide();
    }

    // Validar formul√°rio antes de enviar
    document.getElementById('postForm').addEventListener('submit', function(e) {
      const title = document.querySelector('input[name="title"]').value.trim();
      const content = editorInstance ? editorInstance.getData().trim() : '';
      
      if (!title) {
        e.preventDefault();
        alert('Por favor, preencha o t√≠tulo do post.');
        return false;
      }
      
      if (!content) {
        e.preventDefault();
        alert('Por favor, preencha o conte√∫do do post.');
        return false;
      }
      
      document.getElementById('contentBackup').value = content;
      return true;
    });

    // Preview de imagem destacada
    document.getElementById('imageInput').addEventListener('change', function(e) {
      const file = e.target.files[0];
      if (file) {
        const reader = new FileReader();
        reader.onload = function(e) {
          document.getElementById('imagePreview').innerHTML = 
            '<img src="' + e.target.result + '" class="img-fluid img-preview w-100 mt-2">';
        };
        reader.readAsDataURL(file);
      }
    });
  </script>
</body>
</html>
