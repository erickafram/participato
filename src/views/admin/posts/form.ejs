<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title><%= isEdit ? 'Editar Post' : 'Novo Post' %> - Admin</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.2/font/bootstrap-icons.css" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <style>
    :root { 
      --primary: #6366f1; 
      --primary-hover: #4f46e5;
      --bg-main: #f8fafc;
      --bg-card: #ffffff;
      --border-color: #e2e8f0;
      --text-primary: #1e293b;
      --text-secondary: #64748b;
      --success: #10b981;
      --warning: #f59e0b;
    }
    * { font-family: 'Inter', sans-serif; box-sizing: border-box; }
    body { background: var(--bg-main); font-size: 14px; color: var(--text-primary); }
    
    /* Header fixo */
    .page-header {
      background: var(--bg-card);
      border-bottom: 1px solid var(--border-color);
      padding: 12px 24px;
      position: sticky;
      top: 0;
      z-index: 100;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .page-header h1 { font-size: 1.1rem; font-weight: 600; margin: 0; display: flex; align-items: center; gap: 10px; }
    .header-actions { display: flex; gap: 10px; align-items: center; }
    
    /* Cards modernos */
    .card {
      background: var(--bg-card);
      border: 1px solid var(--border-color);
      border-radius: 12px;
      box-shadow: 0 1px 3px rgba(0,0,0,0.04);
      overflow: hidden;
    }
    .card-header {
      background: transparent;
      border-bottom: 1px solid var(--border-color);
      padding: 14px 18px;
      font-weight: 600;
      font-size: 0.9rem;
      display: flex;
      align-items: center;
      gap: 8px;
    }
</style>
</head>
<body>
<style>
    .card-header i { color: var(--primary); }
    .card-body { padding: 18px; }
    
    /* Formulário */
    .form-label { font-weight: 500; color: var(--text-primary); margin-bottom: 6px; font-size: 0.85rem; }
    .form-control, .form-select {
      border: 1.5px solid var(--border-color);
      border-radius: 8px;
      padding: 10px 14px;
      font-size: 0.9rem;
      transition: all 0.2s;
    }
    .form-control:focus, .form-select:focus {
      border-color: var(--primary);
      box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.1);
      outline: none;
    }
    .form-control-lg { padding: 12px 16px; font-size: 1.1rem; }
    .input-title { font-weight: 600; }
    
    /* Botões */
    .btn { 
      font-size: 0.875rem; 
      padding: 10px 18px; 
      border-radius: 8px; 
      font-weight: 500;
      transition: all 0.2s;
      display: inline-flex;
      align-items: center;
      gap: 6px;
    }
    .btn-primary { 
      background: var(--primary); 
      border: none; 
      color: white;
    }
    .btn-primary:hover { background: var(--primary-hover); transform: translateY(-1px); }
    .btn-success { background: var(--success); border: none; }
    .btn-outline-secondary { 
      border: 1.5px solid var(--border-color); 
      color: var(--text-secondary);
      background: transparent;
    }
    .btn-outline-secondary:hover { background: var(--bg-main); border-color: var(--text-secondary); }
    .btn-sm { padding: 6px 12px; font-size: 0.8rem; }
    .btn-lg { padding: 12px 24px; font-size: 0.95rem; }
    
    /* Editor CKEditor menor */
    .ck-editor__editable { min-height: 180px !important; max-height: 250px !important; font-size: 0.95rem; }
    
    /* Toolbar de imagem no editor */
    .image-toolbar {
      position: absolute;
      background: #1e293b;
      border-radius: 8px;
      padding: 6px;
      display: flex;
      gap: 4px;
      z-index: 1000;
      box-shadow: 0 4px 12px rgba(0,0,0,0.3);
      animation: fadeIn 0.2s ease;
    }
    .image-toolbar button {
      background: transparent;
      border: none;
      color: white;
      width: 32px;
      height: 32px;
      border-radius: 6px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 14px;
      transition: all 0.2s;
    }
    .image-toolbar button:hover { background: rgba(255,255,255,0.15); }
    .image-toolbar button.delete-btn:hover { background: #ef4444; }
    .image-toolbar::after {
      content: '';
      position: absolute;
      bottom: -6px;
      left: 50%;
      transform: translateX(-50%);
      border-left: 6px solid transparent;
      border-right: 6px solid transparent;
      border-top: 6px solid #1e293b;
    }
    .ck-editor__editable img.selected-image {
      outline: 3px solid var(--primary);
      outline-offset: 2px;
    }
    
    /* Upload de imagem moderno */
    .image-upload-area {
      border: 2px dashed var(--border-color);
      border-radius: 12px;
      padding: 24px;
      text-align: center;
      cursor: pointer;
      transition: all 0.3s;
      background: var(--bg-main);
    }
    .image-upload-area:hover { border-color: var(--primary); background: rgba(99, 102, 241, 0.03); }
    .image-upload-area.has-image { padding: 12px; }
    .image-upload-area .upload-icon { font-size: 2.5rem; color: var(--text-secondary); margin-bottom: 8px; }
    .image-upload-area img { max-height: 150px; border-radius: 8px; object-fit: cover; }
    .image-upload-area .upload-text { color: var(--text-secondary); font-size: 0.85rem; }
    .image-upload-area .upload-hint { color: var(--text-secondary); font-size: 0.75rem; margin-top: 4px; }
</style>
<style>
    /* Preview de imagem */
    .img-preview-container { position: relative; display: inline-block; }
    .img-preview-container .remove-btn {
      position: absolute;
      top: -8px;
      right: -8px;
      background: #ef4444;
      color: white;
      border: none;
      border-radius: 50%;
      width: 24px;
      height: 24px;
      cursor: pointer;
      font-size: 12px;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    
    /* Status badges */
    .status-option { display: flex; align-items: center; gap: 8px; padding: 10px 14px; border-radius: 8px; cursor: pointer; transition: all 0.2s; border: 2px solid transparent; }
    .status-option:hover { background: var(--bg-main); }
    .status-option.active { border-color: var(--primary); background: rgba(99, 102, 241, 0.05); }
    .status-option input { display: none; }
    .status-icon { width: 32px; height: 32px; border-radius: 8px; display: flex; align-items: center; justify-content: center; font-size: 1rem; }
    .status-draft .status-icon { background: #fef3c7; color: #d97706; }
    .status-published .status-icon { background: #d1fae5; color: #059669; }
    .status-scheduled .status-icon { background: #dbeafe; color: #2563eb; }
    
    /* Seções colapsáveis */
    .collapsible-header { cursor: pointer; user-select: none; }
    .collapsible-header .chevron { transition: transform 0.2s; }
    .collapsible-header.collapsed .chevron { transform: rotate(-90deg); }
    
    /* Tags input */
    .tags-container { display: flex; flex-wrap: wrap; gap: 6px; padding: 8px; border: 1.5px solid var(--border-color); border-radius: 8px; min-height: 44px; cursor: text; }
    .tags-container:focus-within { border-color: var(--primary); box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.1); }
    .tag-item { background: var(--primary); color: white; padding: 4px 10px; border-radius: 6px; font-size: 0.8rem; display: flex; align-items: center; gap: 6px; }
    .tag-item .remove-tag { cursor: pointer; opacity: 0.8; }
    .tag-item .remove-tag:hover { opacity: 1; }
    .tags-input { border: none; outline: none; flex: 1; min-width: 100px; font-size: 0.85rem; }
    
    /* Layout responsivo */
    .main-content { padding: 24px; }
    .content-grid { display: grid; grid-template-columns: 1fr 340px; gap: 24px; }
    @media (max-width: 1024px) { .content-grid { grid-template-columns: 1fr; } }
    
    /* Animações */
    .fade-in { animation: fadeIn 0.3s ease; }
    @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    
    /* Tooltip de conversão WebP */
    .webp-badge { 
      background: linear-gradient(135deg, #10b981, #059669); 
      color: white; 
      font-size: 0.7rem; 
      padding: 3px 8px; 
      border-radius: 4px; 
      font-weight: 600;
      display: inline-flex;
      align-items: center;
      gap: 4px;
    }
    
    /* Estilos do Assistente de IA */
    .ai-assistant-card { border: 1px solid #c7d2fe; background: linear-gradient(135deg, #fefeff 0%, #f5f3ff 100%); }
    .ai-header { background: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%); color: white !important; }
    .ai-header i { color: white !important; }
    .ai-badge-small { background: rgba(255,255,255,0.25); padding: 2px 6px; border-radius: 8px; font-size: 0.65rem; font-weight: 600; margin-left: auto; }
    .btn-ai { background: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%); color: white; border: none; font-weight: 500; }
    .btn-ai:hover { background: linear-gradient(135deg, #4f46e5 0%, #7c3aed 100%); color: white; transform: translateY(-1px); }
    .btn-ai:disabled { opacity: 0.6; cursor: not-allowed; transform: none; }
    .btn-outline-ai { border: 1.5px solid #c7d2fe; color: #6366f1; background: white; }
    .btn-outline-ai:hover { background: #f5f3ff; border-color: #6366f1; color: #4f46e5; }
    
    /* Input com botão de IA */
    .input-with-ai { position: relative; display: flex; align-items: center; }
    .input-with-ai input { padding-right: 40px; }
    .ai-field-btn {
      position: absolute;
      right: 8px;
      background: linear-gradient(135deg, #6366f1, #8b5cf6);
      border: none;
      color: white;
      width: 28px;
      height: 28px;
      border-radius: 6px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 0.85rem;
      transition: all 0.2s;
      opacity: 0.8;
    }
    .ai-field-btn:hover { opacity: 1; transform: scale(1.05); }
    .ai-field-btn:disabled { opacity: 0.4; cursor: not-allowed; }
    .ai-field-btn.loading { animation: pulse 1s infinite; }
    @keyframes pulse { 0%, 100% { opacity: 0.6; } 50% { opacity: 1; } }
    
    /* Loading overlay */
    .ai-loading { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); display: flex; align-items: center; justify-content: center; z-index: 9999; }
    .ai-loading-content { background: white; padding: 30px 40px; border-radius: 12px; text-align: center; }
    .ai-loading-content i { font-size: 2.5rem; color: #6366f1; animation: pulse 1s infinite; }
    .ai-loading-content p { margin: 15px 0 0; font-weight: 500; color: #374151; }
</style>
<style>
    /* Modal de mídia */
    .media-gallery { display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px; max-height: 350px; overflow-y: auto; }
    .media-item { cursor: pointer; border: 2px solid transparent; border-radius: 8px; overflow: hidden; transition: all 0.2s; }
    .media-item:hover { border-color: var(--primary); transform: scale(1.02); }
    .media-item.selected { border-color: var(--primary); box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.3); }
    .media-item img { width: 100%; height: 80px; object-fit: cover; }
    .upload-zone { border: 2px dashed var(--border-color); border-radius: 8px; padding: 20px; text-align: center; cursor: pointer; transition: all 0.2s; }
    .upload-zone:hover { border-color: var(--primary); background: rgba(99, 102, 241, 0.03); }
    .upload-zone.dragover { border-color: var(--primary); background: rgba(99, 102, 241, 0.08); }
    
    /* Featured Image Card - Novo Layout */
    .featured-image-card { overflow: hidden; }
    .featured-image-card .card-body { background: #fafbfc; }
    
    /* Tabs estilizadas */
    .featured-tabs {
      display: flex;
      background: #fff;
      border-bottom: 1px solid var(--border-color);
    }
    .featured-tab {
      flex: 1;
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 4px;
      padding: 12px 8px;
      border: none;
      background: transparent;
      color: var(--text-secondary);
      font-size: 0.75rem;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.2s;
      position: relative;
    }
    .featured-tab i { font-size: 1.1rem; }
    .featured-tab:hover { color: var(--primary); background: rgba(99, 102, 241, 0.03); }
    .featured-tab.active { color: var(--primary); background: #fafbfc; }
    .featured-tab.active::after {
      content: '';
      position: absolute;
      bottom: -1px;
      left: 0;
      right: 0;
      height: 2px;
      background: var(--primary);
    }
    
    /* Upload Area */
    .featured-upload-area {
      border: 2px dashed #d1d5db;
      border-radius: 12px;
      padding: 24px 16px;
      text-align: center;
      cursor: pointer;
      transition: all 0.3s;
      background: #fff;
      min-height: 140px;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    .featured-upload-area:hover { border-color: var(--primary); background: rgba(99, 102, 241, 0.02); }
    .featured-upload-area.dragover { border-color: var(--primary); background: rgba(99, 102, 241, 0.05); border-style: solid; }
    .featured-upload-area.has-image { padding: 8px; border-style: solid; border-color: var(--border-color); }
    
    .upload-placeholder { text-align: center; }
    .upload-icon-wrapper {
      width: 48px;
      height: 48px;
      margin: 0 auto 12px;
      background: linear-gradient(135deg, #e0e7ff 0%, #c7d2fe 100%);
      border-radius: 12px;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    .upload-icon-wrapper i { font-size: 1.5rem; color: var(--primary); }
    .upload-placeholder .upload-text { font-size: 0.85rem; font-weight: 500; color: var(--text-primary); margin-bottom: 4px; }
    .upload-placeholder .upload-formats { font-size: 0.75rem; color: var(--text-secondary); }
    
    /* Preview Container */
    .featured-preview-container { position: relative; width: 100%; }
    .featured-preview-container img { width: 100%; max-height: 180px; object-fit: cover; border-radius: 8px; }
    .featured-preview-overlay {
      position: absolute;
      inset: 0;
      background: rgba(0,0,0,0.5);
      border-radius: 8px;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      opacity: 0;
      transition: opacity 0.2s;
    }
    .featured-preview-container:hover .featured-preview-overlay { opacity: 1; }
    .featured-preview-overlay .btn-change,
    .featured-preview-overlay .btn-remove {
      padding: 8px 14px;
      border-radius: 6px;
      border: none;
      font-size: 0.8rem;
      font-weight: 500;
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 6px;
    }
    .btn-change { background: #fff; color: var(--text-primary); }
    .btn-remove { background: #ef4444; color: #fff; }
    
    /* Gallery Grid */
    .gallery-search {
      position: relative;
      margin-bottom: 12px;
    }
    .gallery-search i {
      position: absolute;
      left: 10px;
      top: 50%;
      transform: translateY(-50%);
      color: var(--text-secondary);
      font-size: 0.85rem;
    }
    .gallery-search input {
      width: 100%;
      padding: 8px 12px 8px 32px;
      border: 1px solid var(--border-color);
      border-radius: 8px;
      font-size: 0.85rem;
    }
    .gallery-search input:focus { outline: none; border-color: var(--primary); }
    
    .featured-gallery-grid {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 8px;
      max-height: 180px;
      overflow-y: auto;
      padding: 2px;
    }
    .featured-gallery-grid .media-item {
      aspect-ratio: 1;
      border-radius: 8px;
      overflow: hidden;
      cursor: pointer;
      border: 2px solid transparent;
      transition: all 0.2s;
    }
    .featured-gallery-grid .media-item:hover { border-color: var(--primary); transform: scale(1.03); }
    .featured-gallery-grid .media-item.selected { border-color: var(--primary); box-shadow: 0 0 0 2px rgba(99, 102, 241, 0.3); }
    .featured-gallery-grid .media-item img { width: 100%; height: 100%; object-fit: cover; }
    
    .gallery-loading {
      grid-column: 1 / -1;
      text-align: center;
      padding: 30px;
      color: var(--text-secondary);
      font-size: 0.85rem;
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 8px;
    }
    
    /* URL Input */
    .url-input-group {
      display: flex;
      align-items: center;
      border: 1px solid var(--border-color);
      border-radius: 8px;
      overflow: hidden;
      background: #fff;
    }
    .url-input-group i { padding: 0 12px; color: var(--text-secondary); }
    .url-input-group input {
      flex: 1;
      border: none;
      padding: 10px 0;
      font-size: 0.85rem;
      outline: none;
    }
    .url-input-group button {
      padding: 10px 14px;
      background: var(--primary);
      color: #fff;
      border: none;
      cursor: pointer;
      transition: background 0.2s;
    }
    .url-input-group button:hover { background: var(--primary-hover); }
    
    .url-preview { margin-top: 12px; }
    .url-preview img { max-height: 120px; border-radius: 8px; }
    
    .url-hint {
      margin-top: 10px;
      font-size: 0.75rem;
      color: var(--text-secondary);
      display: flex;
      align-items: center;
      gap: 6px;
    }
    
    /* Selected Preview */
    .featured-selected-preview {
      padding: 12px;
      background: #fff;
      border-top: 1px solid var(--border-color);
      text-align: center;
    }
    .selected-image-wrapper { position: relative; display: inline-block; }
    .selected-image-wrapper img { max-height: 140px; border-radius: 8px; }
    .selected-image-actions {
      display: flex;
      justify-content: center;
      gap: 8px;
      margin-top: 10px;
    }
    .btn-action-change, .btn-action-remove {
      padding: 6px 12px;
      border-radius: 6px;
      font-size: 0.8rem;
      font-weight: 500;
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 4px;
      border: 1px solid var(--border-color);
      background: #fff;
      color: var(--text-secondary);
      transition: all 0.2s;
    }
    .btn-action-change:hover { border-color: var(--primary); color: var(--primary); }
    .btn-action-remove:hover { border-color: #ef4444; color: #ef4444; background: #fef2f2; }
    
    /* Quick actions */
    .quick-action { 
      display: flex; 
      align-items: center; 
      gap: 10px; 
      padding: 12px 14px; 
      border-radius: 8px; 
      cursor: pointer; 
      transition: all 0.2s;
      border: 1.5px solid var(--border-color);
    }
    .quick-action:hover { background: var(--bg-main); border-color: var(--primary); }
    .quick-action i { font-size: 1.2rem; color: var(--primary); }
    .quick-action-text { font-size: 0.85rem; }
    .quick-action-text small { display: block; color: var(--text-secondary); font-size: 0.75rem; }
  </style>
</head>
<body>
  <!-- Header fixo -->
  <header class="page-header">
    <h1>
      <a href="/admin/posts" class="text-decoration-none text-secondary">
        <i class="bi bi-arrow-left"></i>
      </a>
      <i class="bi bi-pencil-square text-primary"></i>
      <%= isEdit ? 'Editar Post' : 'Nova Notícia' %>
    </h1>
    <div class="header-actions">
      <% if (isEdit && post) { %>
        <a href="/noticia/<%= post.slug %>" target="_blank" class="btn btn-outline-secondary btn-sm">
          <i class="bi bi-eye"></i> Visualizar
        </a>
      <% } %>
      <button type="submit" form="postForm" class="btn btn-primary">
        <i class="bi bi-check-lg"></i> <%= isEdit ? 'Salvar' : 'Publicar' %>
      </button>
    </div>
  </header>

  <main class="main-content">
    <form id="postForm" action="<%= isEdit ? '/admin/posts/' + post.id : '/admin/posts' %>" method="POST" enctype="multipart/form-data">
      <div class="content-grid">
        <!-- Coluna Principal -->
        <div class="main-column">
          <!-- Título e Subtítulo -->
          <div class="card mb-3 fade-in">
            <div class="card-body">
              <div class="mb-3">
                <div class="input-with-ai">
                  <input type="text" name="title" id="titleInput" class="form-control form-control-lg input-title" 
                         value="<%= post ? post.title : '' %>" required 
                         placeholder="Título da notícia" autofocus>
                  <button type="button" class="ai-field-btn" onclick="improveField('title')" title="Melhorar com IA">
                    <i class="bi bi-magic"></i>
                  </button>
                </div>
              </div>
              <div>
                <div class="input-with-ai">
                  <input type="text" name="subtitle" id="subtitleInput" class="form-control" 
                         value="<%= post ? (post.subtitle || '') : '' %>" 
                         placeholder="Subtítulo ou resumo curto (opcional)">
                  <button type="button" class="ai-field-btn" onclick="improveField('subtitle')" title="Melhorar com IA">
                    <i class="bi bi-magic"></i>
                  </button>
                </div>
              </div>
            </div>
          </div>

          <!-- Editor de Conteúdo -->
          <div class="card mb-3 fade-in" style="animation-delay: 0.1s;">
            <div class="card-header">
              <i class="bi bi-text-paragraph"></i> Conteúdo
              <div class="ms-auto d-flex gap-2">
                <button type="button" class="btn btn-outline-secondary btn-sm" onclick="improveField('content')" title="Melhorar conteúdo com IA">
                  <i class="bi bi-magic"></i> Melhorar
                </button>
                <button type="button" class="btn btn-outline-secondary btn-sm" onclick="openMediaModal()">
                  <i class="bi bi-image"></i> Imagem
                </button>
              </div>
            </div>
            <div class="card-body" style="padding: 12px;">
              <textarea name="content" id="editor"><%= post ? post.content : '' %></textarea>
              <input type="hidden" name="content_backup" id="contentBackup">
            </div>
          </div>

          <!-- Embed de Mídia (Colapsável) -->
          <div class="card mb-3 fade-in" style="animation-delay: 0.2s;">
            <div class="card-header collapsible-header" data-bs-toggle="collapse" data-bs-target="#embedSection">
              <i class="bi bi-play-circle"></i> Embed de Mídia
              <small class="text-muted ms-2">YouTube, Instagram, TikTok</small>
              <i class="bi bi-chevron-down chevron ms-auto"></i>
            </div>
            <div class="collapse" id="embedSection">
              <div class="card-body">
                <textarea name="embed_code" class="form-control" rows="3" 
                          placeholder="Cole o código embed aqui..."><%= post ? (post.embed_code || '') : '' %></textarea>
                <small class="text-muted mt-2 d-block">
                  <i class="bi bi-info-circle"></i> Cole o código de incorporação do YouTube, Instagram, Facebook ou TikTok.
                </small>
              </div>
            </div>
          </div>

          <!-- SEO (Colapsável) -->
          <div class="card fade-in" style="animation-delay: 0.3s;">
            <div class="card-header collapsible-header" data-bs-toggle="collapse" data-bs-target="#seoSection">
              <i class="bi bi-search"></i> SEO
              <small class="text-muted ms-2">Opcional</small>
              <i class="bi bi-chevron-down chevron ms-auto"></i>
            </div>
            <div class="collapse" id="seoSection">
              <div class="card-body">
                <div class="mb-3">
                  <label class="form-label">URL amigável</label>
                  <div class="input-group">
                    <span class="input-group-text" style="font-size: 0.85rem;">/noticia/</span>
                    <input type="text" name="slug" class="form-control" 
                           value="<%= post ? post.slug : '' %>" placeholder="url-da-noticia">
                  </div>
                </div>
                <div class="row">
                  <div class="col-md-6 mb-3">
                    <label class="form-label">Meta Título</label>
                    <input type="text" name="meta_title" class="form-control" 
                           value="<%= post ? (post.meta_title || '') : '' %>" maxlength="70">
                  </div>
                  <div class="col-md-6 mb-3">
                    <label class="form-label">Meta Descrição</label>
                    <textarea name="meta_description" class="form-control" rows="1" 
                              maxlength="160"><%= post ? (post.meta_description || '') : '' %></textarea>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Sidebar -->
        <div class="sidebar-column">
          <!-- Assistente de IA -->
          <div class="card mb-3 fade-in ai-assistant-card" id="aiCard" style="display: none;">
            <div class="card-header ai-header">
              <i class="bi bi-robot"></i> Assistente IA
              <span class="ai-badge-small">Pro</span>
            </div>
            <div class="card-body">
              <div class="ai-generate-section">
                <label class="form-label">Tema da matéria</label>
                <input type="text" id="aiKeyword" class="form-control mb-2" placeholder="Ex: Acidente na BR-153 em Gurupi" maxlength="150">
                <small class="text-muted d-block mb-2" style="font-size: 0.7rem;">Máximo 150 caracteres</small>
                
                <label class="form-label">Estilo de escrita</label>
                <select id="aiStyle" class="form-select mb-2">
                  <option value="globo">Hard News (neutro, factual)</option>
                  <option value="metropoles_politica">Política (bastidores, análise)</option>
                  <option value="metropoles_policial">Policial (narrativo, crônica)</option>
                </select>
                
                <div class="form-check mb-2">
                  <input type="checkbox" class="form-check-input" id="aiSearchWeb" checked>
                  <label class="form-check-label" for="aiSearchWeb">
                    <i class="bi bi-globe"></i> Pesquisar notícias na internet
                  </label>
                </div>
                
                <button type="button" class="btn btn-ai w-100" onclick="generateArticle()">
                  <i class="bi bi-stars"></i> Gerar Matéria
                </button>
                
                <small class="text-muted d-block mt-2 text-center">
                  <i class="bi bi-shield-check"></i> Texto humanizado, sem plágio
                </small>
              </div>
              <hr class="my-3">
              <div class="ai-actions">
                <small class="text-muted d-block mb-2">Melhorar campos individuais:</small>
                <div class="d-flex flex-wrap gap-2">
                  <button type="button" class="btn btn-outline-ai btn-sm" onclick="improveField('title')">
                    <i class="bi bi-type-h1"></i> Título
                  </button>
                  <button type="button" class="btn btn-outline-ai btn-sm" onclick="improveField('subtitle')">
                    <i class="bi bi-type-h2"></i> Subtítulo
                  </button>
                  <button type="button" class="btn btn-outline-ai btn-sm" onclick="improveField('content')">
                    <i class="bi bi-text-paragraph"></i> Conteúdo
                  </button>
                </div>
              </div>
            </div>
          </div>

          <!-- Status de Publicação -->
          <div class="card mb-3 fade-in">
            <div class="card-header">
              <i class="bi bi-send"></i> Publicação
            </div>
            <div class="card-body">
              <div class="d-flex flex-column gap-2 mb-3">
                <label class="status-option status-draft <%= (!post || post.status === 'draft') ? 'active' : '' %>">
                  <input type="radio" name="status" value="draft" <%= (!post || post.status === 'draft') ? 'checked' : '' %>>
                  <span class="status-icon"><i class="bi bi-pencil"></i></span>
                  <span>Rascunho</span>
                </label>
                <label class="status-option status-published <%= (post && post.status === 'published') ? 'active' : '' %>">
                  <input type="radio" name="status" value="published" <%= (post && post.status === 'published') ? 'checked' : '' %>>
                  <span class="status-icon"><i class="bi bi-check-lg"></i></span>
                  <span>Publicado</span>
                </label>
                <label class="status-option status-scheduled <%= (post && post.status === 'scheduled') ? 'active' : '' %>">
                  <input type="radio" name="status" value="scheduled" <%= (post && post.status === 'scheduled') ? 'checked' : '' %>>
                  <span class="status-icon"><i class="bi bi-calendar"></i></span>
                  <span>Agendado</span>
                </label>
              </div>
              
              <div id="scheduleField" class="mb-3" style="display: none;">
                <label class="form-label">Agendar para</label>
                <input type="datetime-local" name="scheduled_at" class="form-control" 
                       value="<%= post && post.scheduled_at ? new Date(post.scheduled_at).toISOString().slice(0,16) : '' %>">
              </div>
              
              <div class="form-check">
                <input type="checkbox" name="featured" class="form-check-input" id="featured" <%= post && post.featured ? 'checked' : '' %>>
                <label class="form-check-label" for="featured">
                  <i class="bi bi-star-fill text-warning"></i> Destaque na Home
                </label>
              </div>
            </div>
          </div>

          <!-- Categoria -->
          <div class="card mb-3 fade-in" style="animation-delay: 0.1s;">
            <div class="card-header">
              <i class="bi bi-folder"></i> Categoria
            </div>
            <div class="card-body py-3">
              <select name="category_id" class="form-select">
                <option value="">Selecione uma categoria</option>
                <% categories.forEach(cat => { %>
                  <option value="<%= cat.id %>" <%= post && post.category_id == cat.id ? 'selected' : '' %>><%= cat.name %></option>
                <% }) %>
              </select>
            </div>
          </div>

          <!-- Tags -->
          <div class="card mb-3 fade-in" style="animation-delay: 0.2s;">
            <div class="card-header">
              <i class="bi bi-tags"></i> Tags
            </div>
            <div class="card-body py-3">
              <input type="text" name="tags" class="form-control" 
                     value="<%= post && post.tags ? (Array.isArray(post.tags) ? post.tags.join(', ') : post.tags) : '' %>" 
                     placeholder="Ex: política, economia, esportes">
              <small class="text-muted">Separe as tags por vírgula</small>
            </div>
          </div>
 
         <!-- Imagem Destacada -->
          <div class="card fade-in featured-image-card" style="animation-delay: 0.3s;">
            <div class="card-header">
              <i class="bi bi-image"></i> Imagem Destacada
              <span class="webp-badge ms-auto"><i class="bi bi-lightning-charge"></i> Auto WebP</span>
            </div>
            <div class="card-body p-0">
              <!-- Tabs estilizadas -->
              <div class="featured-tabs">
                <button class="featured-tab active" type="button" onclick="switchFeaturedTab('upload')">
                  <i class="bi bi-cloud-arrow-up"></i>
                  <span>Upload</span>
                </button>
                <button class="featured-tab" type="button" onclick="switchFeaturedTab('gallery')">
                  <i class="bi bi-images"></i>
                  <span>Galeria</span>
                </button>
                <button class="featured-tab" type="button" onclick="switchFeaturedTab('url')">
                  <i class="bi bi-link-45deg"></i>
                  <span>URL</span>
                </button>
              </div>
              
              <div class="featured-tab-content p-3">
                <!-- Tab Upload -->
                <div class="featured-tab-pane active" id="featuredUploadTab">
                  <div class="featured-upload-area <%= post && post.featured_image ? 'has-image' : '' %>" 
                       onclick="document.getElementById('imageInput').click()" id="uploadArea">
                    <% if (post && post.featured_image) { %>
                      <div class="featured-preview-container">
                        <img src="<%= post.featured_image %>" alt="Preview" id="currentImage">
                        <div class="featured-preview-overlay">
                          <button type="button" class="btn-change" onclick="event.stopPropagation();">
                            <i class="bi bi-pencil"></i> Alterar
                          </button>
                          <button type="button" class="btn-remove" onclick="event.stopPropagation(); removeFeaturedImage();">
                            <i class="bi bi-trash"></i>
                          </button>
                        </div>
                      </div>
                    <% } else { %>
                      <div id="uploadPlaceholder" class="upload-placeholder">
                        <div class="upload-icon-wrapper">
                          <i class="bi bi-cloud-arrow-up"></i>
                        </div>
                        <div class="upload-text">Arraste uma imagem ou clique para selecionar</div>
                        <div class="upload-formats">JPG, PNG, GIF, WebP • Máx 10MB</div>
                      </div>
                    <% } %>
                  </div>
                  <input type="file" name="featured_image" class="d-none" accept="image/*" id="imageInput">
                </div>
                
                <!-- Tab Galeria -->
                <div class="featured-tab-pane" id="featuredGalleryTab" style="display: none;">
                  <div class="gallery-search mb-2">
                    <i class="bi bi-search"></i>
                    <input type="text" placeholder="Buscar na galeria..." id="gallerySearchInput" onkeyup="filterGallery(this.value)">
                  </div>
                  <div id="featuredGallery" class="featured-gallery-grid">
                    <div class="gallery-loading">
                      <div class="spinner-border spinner-border-sm text-primary"></div>
                      <span>Carregando imagens...</span>
                    </div>
                  </div>
                </div>
                
                <!-- Tab URL -->
                <div class="featured-tab-pane" id="featuredUrlTab" style="display: none;">
                  <div class="url-input-group">
                    <i class="bi bi-link-45deg"></i>
                    <input type="url" id="featuredImageUrl" placeholder="Cole a URL da imagem aqui...">
                    <button type="button" onclick="setFeaturedFromUrl()" title="Carregar">
                      <i class="bi bi-arrow-right"></i>
                    </button>
                  </div>
                  <div id="featuredUrlPreview" class="url-preview"></div>
                  <div class="url-hint">
                    <i class="bi bi-info-circle"></i>
                    Cole uma URL de imagem válida (JPG, PNG, GIF, WebP)
                  </div>
                </div>
              </div>
              
              <!-- Preview da imagem selecionada -->
              <div id="featuredImagePreview" class="featured-selected-preview" style="display: none;">
                <div class="selected-image-wrapper">
                  <img src="" alt="Preview" id="selectedFeaturedImg">
                  <div class="selected-image-actions">
                    <button type="button" class="btn-action-change" onclick="removeFeaturedImage()">
                      <i class="bi bi-arrow-repeat"></i> Trocar
                    </button>
                    <button type="button" class="btn-action-remove" onclick="removeFeaturedImage()">
                      <i class="bi bi-trash"></i> Remover
                    </button>
                  </div>
                </div>
              </div>
              
              <!-- Campo hidden para URL da imagem da galeria -->
              <input type="hidden" name="featured_image_url" id="featuredImageUrlInput" value="">
            </div>
          </div>
        </div>
      </div>
    </form>
  </main>

  <!-- Modal de Mídia -->
  <div class="modal fade" id="mediaModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" style="font-size: 1rem;"><i class="bi bi-images me-2"></i>Inserir Imagem</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <ul class="nav nav-tabs mb-3" role="tablist">
            <li class="nav-item">
              <button class="nav-link active" data-bs-toggle="tab" data-bs-target="#uploadTab">
                <i class="bi bi-cloud-upload me-1"></i>Upload
              </button>
            </li>
            <li class="nav-item">
              <button class="nav-link" data-bs-toggle="tab" data-bs-target="#galleryTab">
                <i class="bi bi-grid me-1"></i>Galeria
              </button>
            </li>
            <li class="nav-item">
              <button class="nav-link" data-bs-toggle="tab" data-bs-target="#urlTab">
                <i class="bi bi-link-45deg me-1"></i>URL
              </button>
            </li>
          </ul>
          
          <div class="tab-content">
            <div class="tab-pane fade show active" id="uploadTab">
              <div class="upload-zone" id="uploadZone" onclick="document.getElementById('mediaUploadInput').click()">
                <i class="bi bi-cloud-arrow-up" style="font-size: 2rem; color: var(--text-secondary);"></i>
                <p class="mb-1 mt-2">Clique ou arraste uma imagem</p>
                <small class="text-muted">Convertido automaticamente para WebP</small>
              </div>
              <input type="file" id="mediaUploadInput" accept="image/*" style="display: none;">
              <div id="uploadPreview" class="mt-3 text-center"></div>
            </div>
            
            <div class="tab-pane fade" id="galleryTab">
              <div id="mediaGallery" class="media-gallery">
                <div class="text-center py-4 w-100">
                  <div class="spinner-border spinner-border-sm text-primary"></div>
                  <p class="mt-2 mb-0">Carregando...</p>
                </div>
              </div>
            </div>
            
            <div class="tab-pane fade" id="urlTab">
              <div class="mb-3">
                <label class="form-label">URL da Imagem</label>
                <input type="url" id="externalImageUrl" class="form-control" placeholder="https://exemplo.com/imagem.jpg">
              </div>
              <div id="urlPreview" class="text-center"></div>
            </div>
          </div>
          
          <div id="imageOptions" class="mt-3 p-3 bg-light rounded" style="display: none;">
            <div class="row g-2">
              <div class="col-md-6">
                <label class="form-label">Texto alternativo</label>
                <input type="text" id="imageAlt" class="form-control" placeholder="Descrição da imagem">
              </div>
              <div class="col-md-6">
                <label class="form-label">Alinhamento</label>
                <select id="imageAlign" class="form-select">
                  <option value="">Padrão</option>
                  <option value="left">Esquerda</option>
                  <option value="center">Centro</option>
                  <option value="right">Direita</option>
                </select>
              </div>
            </div>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Cancelar</button>
          <button type="button" class="btn btn-primary" id="insertImageBtn" disabled onclick="insertImageToEditor()">
            <i class="bi bi-plus-lg"></i> Inserir
          </button>
        </div>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://cdn.ckeditor.com/ckeditor5/40.1.0/classic/ckeditor.js"></script>
  <script>
    let editorInstance;
    let selectedImageUrl = '';
    let mediaModal;
    
    // Inicializar CKEditor
    ClassicEditor
      .create(document.querySelector('#editor'), {
        toolbar: ['heading', '|', 'bold', 'italic', 'link', '|', 'bulletedList', 'numberedList', '|', 'blockQuote', '|', 'undo', 'redo'],
        placeholder: 'Escreva o conteúdo da notícia...'
      })
      .then(editor => { 
        editorInstance = editor;
        
        // Adicionar listener para cliques em imagens
        const editorElement = editor.ui.view.editable.element;
        
        editorElement.addEventListener('click', function(e) {
          // Remover toolbar anterior
          removeImageToolbar();
          
          // Verificar se clicou em uma imagem
          if (e.target.tagName === 'IMG') {
            e.target.classList.add('selected-image');
            showImageToolbar(e.target);
          }
        });
        
        // Remover toolbar ao clicar fora
        document.addEventListener('click', function(e) {
          if (!e.target.closest('.image-toolbar') && e.target.tagName !== 'IMG') {
            removeImageToolbar();
          }
        });
      })
      .catch(error => console.error(error));
    
    // Mostrar toolbar de imagem
    function showImageToolbar(img) {
      const toolbar = document.createElement('div');
      toolbar.className = 'image-toolbar';
      toolbar.id = 'imageToolbar';
      toolbar.innerHTML = `
        <button type="button" onclick="alignEditorImage('left')" title="Alinhar à esquerda">
          <i class="bi bi-text-left"></i>
        </button>
        <button type="button" onclick="alignEditorImage('center')" title="Centralizar">
          <i class="bi bi-text-center"></i>
        </button>
        <button type="button" onclick="alignEditorImage('right')" title="Alinhar à direita">
          <i class="bi bi-text-right"></i>
        </button>
        <button type="button" class="delete-btn" onclick="deleteEditorImage()" title="Excluir imagem">
          <i class="bi bi-trash"></i>
        </button>
      `;
      
      document.body.appendChild(toolbar);
      
      // Posicionar toolbar acima da imagem
      const rect = img.getBoundingClientRect();
      toolbar.style.left = (rect.left + rect.width / 2 - toolbar.offsetWidth / 2) + 'px';
      toolbar.style.top = (rect.top - toolbar.offsetHeight - 10 + window.scrollY) + 'px';
      
      // Guardar referência da imagem selecionada
      window.selectedEditorImage = img;
    }
    
    // Remover toolbar
    function removeImageToolbar() {
      const toolbar = document.getElementById('imageToolbar');
      if (toolbar) toolbar.remove();
      document.querySelectorAll('.selected-image').forEach(img => img.classList.remove('selected-image'));
      window.selectedEditorImage = null;
    }
    
    // Alinhar imagem no editor
    function alignEditorImage(align) {
      if (!window.selectedEditorImage || !editorInstance) return;
      const img = window.selectedEditorImage;
      const imgSrc = img.getAttribute('src');
      
      // Pegar o conteúdo atual do editor
      let content = editorInstance.getData();
      
      // Criar um elemento temporário para manipular o HTML
      const tempDiv = document.createElement('div');
      tempDiv.innerHTML = content;
      
      // Encontrar a imagem pelo src e aplicar estilo
      const images = tempDiv.querySelectorAll('img');
      images.forEach(image => {
        if (image.getAttribute('src') === imgSrc) {
          // Resetar estilos
          image.style.float = '';
          image.style.display = '';
          image.style.marginLeft = '';
          image.style.marginRight = '';
          
          if (align === 'left') {
            image.style.cssText = 'float: left; margin-right: 15px; margin-bottom: 15px; max-width: 100%;';
          } else if (align === 'right') {
            image.style.cssText = 'float: right; margin-left: 15px; margin-bottom: 15px; max-width: 100%;';
          } else if (align === 'center') {
            image.style.cssText = 'display: block; margin: 0 auto 15px auto; max-width: 100%;';
          }
        }
      });
      
      // Atualizar o conteúdo do editor
      editorInstance.setData(tempDiv.innerHTML);
      
      removeImageToolbar();
    }
    
    // Excluir imagem do editor
    function deleteEditorImage() {
      if (!window.selectedEditorImage || !editorInstance) return;
      
      if (confirm('Deseja excluir esta imagem?')) {
        const img = window.selectedEditorImage;
        
        // Pegar o conteúdo atual do editor
        let content = editorInstance.getData();
        
        // Criar um elemento temporário para manipular o HTML
        const tempDiv = document.createElement('div');
        tempDiv.innerHTML = content;
        
        // Encontrar e remover a imagem pelo src
        const imgSrc = img.getAttribute('src');
        const images = tempDiv.querySelectorAll('img');
        images.forEach(image => {
          if (image.getAttribute('src') === imgSrc) {
            image.remove();
          }
        });
        
        // Atualizar o conteúdo do editor
        editorInstance.setData(tempDiv.innerHTML);
        
        removeImageToolbar();
      }
    }

    document.addEventListener('DOMContentLoaded', function() {
      mediaModal = new bootstrap.Modal(document.getElementById('mediaModal'));
      
      // Status radio buttons
      document.querySelectorAll('.status-option').forEach(option => {
        option.addEventListener('click', function() {
          document.querySelectorAll('.status-option').forEach(o => o.classList.remove('active'));
          this.classList.add('active');
          const isScheduled = this.querySelector('input').value === 'scheduled';
          document.getElementById('scheduleField').style.display = isScheduled ? 'block' : 'none';
        });
      });
      
      // Mostrar campo de agendamento se já estiver selecionado
      if (document.querySelector('input[name="status"][value="scheduled"]:checked')) {
        document.getElementById('scheduleField').style.display = 'block';
      }
      
      // Collapsible headers
      document.querySelectorAll('.collapsible-header').forEach(header => {
        header.addEventListener('click', function() {
          this.classList.toggle('collapsed');
        });
      });
      
    });

    // Upload de imagem destacada com drag and drop
    const uploadArea = document.getElementById('uploadArea');
    const imageInput = document.getElementById('imageInput');
    
    uploadArea.addEventListener('dragover', (e) => { e.preventDefault(); uploadArea.style.borderColor = 'var(--primary)'; });
    uploadArea.addEventListener('dragleave', () => { uploadArea.style.borderColor = ''; });
    uploadArea.addEventListener('drop', (e) => {
      e.preventDefault();
      uploadArea.style.borderColor = '';
      const file = e.dataTransfer.files[0];
      if (file && file.type.startsWith('image/')) {
        const dt = new DataTransfer();
        dt.items.add(file);
        imageInput.files = dt.files;
        previewImage(file);
      }
    });
    
    imageInput.addEventListener('change', function(e) {
      if (e.target.files[0]) previewImage(e.target.files[0]);
    });
    
    function previewImage(file) {
      const reader = new FileReader();
      reader.onload = function(e) {
        uploadArea.innerHTML = `
          <div class="featured-preview-container">
            <img src="${e.target.result}" alt="Preview">
            <div class="featured-preview-overlay">
              <button type="button" class="btn-change" onclick="event.stopPropagation();">
                <i class="bi bi-pencil"></i> Alterar
              </button>
              <button type="button" class="btn-remove" onclick="event.stopPropagation(); removeFeaturedImage();">
                <i class="bi bi-trash"></i>
              </button>
            </div>
          </div>
        `;
        uploadArea.classList.add('has-image');
        // Limpa URL se fez upload
        document.getElementById('featuredImageUrlInput').value = '';
      };
      reader.readAsDataURL(file);
    }
    
    function removeImage() {
      removeFeaturedImage();
    }

    // ========== FEATURED IMAGE FUNCTIONS ==========
    let featuredGalleryLoaded = false;
    let galleryItems = [];
    
    function switchFeaturedTab(tab) {
      // Remove active de todas as tabs
      document.querySelectorAll('.featured-tab').forEach(t => t.classList.remove('active'));
      
      // Esconde todos os painéis
      document.querySelectorAll('.featured-tab-pane').forEach(p => {
        p.style.display = 'none';
        p.classList.remove('active');
      });
      
      // Ativa a tab clicada
      const tabs = document.querySelectorAll('.featured-tab');
      if (tab === 'upload') {
        tabs[0].classList.add('active');
        document.getElementById('featuredUploadTab').style.display = 'block';
      } else if (tab === 'gallery') {
        tabs[1].classList.add('active');
        document.getElementById('featuredGalleryTab').style.display = 'block';
        loadFeaturedGallery();
      } else if (tab === 'url') {
        tabs[2].classList.add('active');
        document.getElementById('featuredUrlTab').style.display = 'block';
      }
    }
    
    async function loadFeaturedGallery() {
      if (featuredGalleryLoaded) return;
      
      const gallery = document.getElementById('featuredGallery');
      try {
        const response = await fetch('/admin/media/browse');
        const data = await response.json();
        if (data.medias && data.medias.length > 0) {
          galleryItems = data.medias;
          renderGalleryItems(galleryItems);
          featuredGalleryLoaded = true;
        } else {
          gallery.innerHTML = '<div class="gallery-loading"><i class="bi bi-images"></i><span>Nenhuma imagem na galeria</span></div>';
        }
      } catch (error) {
        gallery.innerHTML = '<div class="gallery-loading"><i class="bi bi-exclamation-circle"></i><span>Erro ao carregar</span></div>';
      }
    }
    
    function renderGalleryItems(items) {
      const gallery = document.getElementById('featuredGallery');
      if (items.length > 0) {
        gallery.innerHTML = items.map(item => `
          <div class="media-item" data-name="${(item.original_name || '').toLowerCase()}" onclick="selectFeaturedFromGallery('${item.url}', this)">
            <img src="${item.url}" alt="${item.alt_text || ''}" loading="lazy">
          </div>
        `).join('');
      } else {
        gallery.innerHTML = '<div class="gallery-loading"><i class="bi bi-search"></i><span>Nenhuma imagem encontrada</span></div>';
      }
    }
    
    function filterGallery(query) {
      const q = query.toLowerCase().trim();
      if (!q) {
        renderGalleryItems(galleryItems);
        return;
      }
      const filtered = galleryItems.filter(item => 
        (item.original_name || '').toLowerCase().includes(q) ||
        (item.alt_text || '').toLowerCase().includes(q)
      );
      renderGalleryItems(filtered);
    }
    
    function selectFeaturedFromGallery(url, element) {
      // Remove seleção anterior
      document.querySelectorAll('#featuredGallery .media-item').forEach(el => el.classList.remove('selected'));
      element.classList.add('selected');
      
      // Define a URL no campo hidden
      document.getElementById('featuredImageUrlInput').value = url;
      
      // Mostra preview
      showFeaturedPreview(url);
      
      // Limpa o input de arquivo
      document.getElementById('imageInput').value = '';
    }
    
    function setFeaturedFromUrl() {
      const url = document.getElementById('featuredImageUrl').value.trim();
      if (!url) {
        alert('Digite uma URL válida');
        return;
      }
      
      // Valida se é uma URL de imagem
      if (!url.match(/\.(jpg|jpeg|png|gif|webp|svg)(\?.*)?$/i) && !url.includes('unsplash') && !url.includes('pexels')) {
        if (!confirm('Esta URL pode não ser uma imagem válida. Deseja continuar?')) {
          return;
        }
      }
      
      // Define a URL no campo hidden
      document.getElementById('featuredImageUrlInput').value = url;
      
      // Mostra preview
      showFeaturedPreview(url);
      
      // Limpa o input de arquivo
      document.getElementById('imageInput').value = '';
      
      // Mostra preview na aba URL
      document.getElementById('featuredUrlPreview').innerHTML = `
        <img src="${url}" alt="Preview" style="max-height: 100px; border-radius: 8px; margin-top: 8px;" 
             onerror="this.style.display='none'; alert('Não foi possível carregar a imagem');">
      `;
    }
    
    function showFeaturedPreview(url) {
      const previewDiv = document.getElementById('featuredImagePreview');
      const previewImg = document.getElementById('selectedFeaturedImg');
      
      previewImg.src = url;
      previewDiv.style.display = 'block';
      
      // Esconde a área de upload
      document.getElementById('uploadArea').style.display = 'none';
    }
    
    function removeFeaturedImage() {
      // Limpa tudo
      document.getElementById('featuredImageUrlInput').value = '';
      document.getElementById('imageInput').value = '';
      const urlInput = document.getElementById('featuredImageUrl');
      if (urlInput) urlInput.value = '';
      const urlPreview = document.getElementById('featuredUrlPreview');
      if (urlPreview) urlPreview.innerHTML = '';
      
      // Esconde preview
      document.getElementById('featuredImagePreview').style.display = 'none';
      
      // Mostra área de upload novamente
      const uploadArea = document.getElementById('uploadArea');
      uploadArea.style.display = 'flex';
      uploadArea.innerHTML = `
        <div id="uploadPlaceholder" class="upload-placeholder">
          <div class="upload-icon-wrapper">
            <i class="bi bi-cloud-arrow-up"></i>
          </div>
          <div class="upload-text">Arraste uma imagem ou clique para selecionar</div>
          <div class="upload-formats">JPG, PNG, GIF, WebP • Máx 10MB</div>
        </div>
      `;
      uploadArea.classList.remove('has-image');
      
      // Remove seleção da galeria
      document.querySelectorAll('#featuredGallery .media-item').forEach(el => el.classList.remove('selected'));
      
      // Volta para a aba de upload
      switchFeaturedTab('upload');
    }

    // ========== MODAL DE MÍDIA ==========
    function openMediaModal() {
      selectedImageUrl = '';
      document.getElementById('insertImageBtn').disabled = true;
      document.getElementById('imageOptions').style.display = 'none';
      document.getElementById('uploadPreview').innerHTML = '';
      document.getElementById('urlPreview').innerHTML = '';
      document.getElementById('externalImageUrl').value = '';
      loadMediaGallery();
      mediaModal.show();
    }

    async function loadMediaGallery() {
      const gallery = document.getElementById('mediaGallery');
      try {
        const response = await fetch('/admin/media/browse');
        const data = await response.json();
        if (data.medias && data.medias.length > 0) {
          gallery.innerHTML = data.medias.map(item => `
            <div class="media-item" onclick="selectGalleryImage('${item.url}', this)">
              <img src="${item.url}" alt="${item.alt_text || ''}">
            </div>
          `).join('');
        } else {
          gallery.innerHTML = '<div class="text-center py-4 w-100"><p class="text-muted mb-0">Nenhuma imagem</p></div>';
        }
      } catch (error) {
        gallery.innerHTML = '<div class="text-center py-4 w-100"><p class="text-muted mb-0">Erro ao carregar</p></div>';
      }
    }

    function selectGalleryImage(url, element) {
      document.querySelectorAll('.media-item').forEach(el => el.classList.remove('selected'));
      element.classList.add('selected');
      selectedImageUrl = url;
      document.getElementById('insertImageBtn').disabled = false;
      document.getElementById('imageOptions').style.display = 'block';
    }

    // Upload no modal
    document.getElementById('mediaUploadInput').addEventListener('change', async function(e) {
      const file = e.target.files[0];
      if (!file) return;
      
      const formData = new FormData();
      formData.append('file', file);
      
      const preview = document.getElementById('uploadPreview');
      preview.innerHTML = '<div class="spinner-border spinner-border-sm text-primary"></div> Enviando...';
      
      try {
        const response = await fetch('/admin/media/upload', { method: 'POST', body: formData });
        const data = await response.json();
        
        if (data.success && data.media) {
          selectedImageUrl = data.media.url;
          preview.innerHTML = `<img src="${data.media.url}" style="max-height: 120px; border-radius: 8px;">`;
          document.getElementById('insertImageBtn').disabled = false;
          document.getElementById('imageOptions').style.display = 'block';
        } else {
          preview.innerHTML = '<p class="text-danger">Erro: ' + (data.message || 'Erro desconhecido') + '</p>';
        }
      } catch (error) {
        preview.innerHTML = '<p class="text-danger">Erro no upload</p>';
      }
    });

    // Drag and drop no modal
    const uploadZone = document.getElementById('uploadZone');
    uploadZone.addEventListener('dragover', (e) => { e.preventDefault(); uploadZone.classList.add('dragover'); });
    uploadZone.addEventListener('dragleave', () => uploadZone.classList.remove('dragover'));
    uploadZone.addEventListener('drop', (e) => {
      e.preventDefault();
      uploadZone.classList.remove('dragover');
      const file = e.dataTransfer.files[0];
      if (file && file.type.startsWith('image/')) {
        const input = document.getElementById('mediaUploadInput');
        const dt = new DataTransfer();
        dt.items.add(file);
        input.files = dt.files;
        input.dispatchEvent(new Event('change'));
      }
    });

    // URL externa
    document.getElementById('externalImageUrl').addEventListener('input', function() {
      const url = this.value.trim();
      const preview = document.getElementById('urlPreview');
      
      if (url && url.startsWith('http')) {
        preview.innerHTML = `<img src="${url}" style="max-height: 120px; border-radius: 8px;" onerror="this.parentElement.innerHTML='<p class=\\'text-danger\\'>Imagem não encontrada</p>'">`;
        selectedImageUrl = url;
        document.getElementById('insertImageBtn').disabled = false;
        document.getElementById('imageOptions').style.display = 'block';
      } else {
        preview.innerHTML = '';
        selectedImageUrl = '';
        document.getElementById('insertImageBtn').disabled = true;
        document.getElementById('imageOptions').style.display = 'none';
      }
    });

    function insertImageToEditor() {
      if (!selectedImageUrl || !editorInstance) return;
      
      const alt = document.getElementById('imageAlt').value || '';
      const align = document.getElementById('imageAlign').value;
      
      let style = 'max-width: 100%; height: auto; margin-bottom: 15px;';
      if (align === 'center') style += ' display: block; margin-left: auto; margin-right: auto;';
      else if (align === 'left') style += ' float: left; margin-right: 15px;';
      else if (align === 'right') style += ' float: right; margin-left: 15px;';
      
      const imgHtml = `<img src="${selectedImageUrl}" alt="${alt}" style="${style}">`;
      const viewFragment = editorInstance.data.processor.toView(imgHtml);
      const modelFragment = editorInstance.data.toModel(viewFragment);
      editorInstance.model.insertContent(modelFragment);
      
      mediaModal.hide();
    }

    // Validação do formulário
    document.getElementById('postForm').addEventListener('submit', function(e) {
      const title = document.querySelector('input[name="title"]').value.trim();
      const content = editorInstance ? editorInstance.getData().trim() : '';
      
      if (!title) { e.preventDefault(); alert('Preencha o título.'); return false; }
      if (!content) { e.preventDefault(); alert('Preencha o conteúdo.'); return false; }
      
      document.getElementById('contentBackup').value = content;
      return true;
    });

    // ==========================================
    // ASSISTENTE DE IA
    // ==========================================
    
    // Verificar se IA está ativada
    async function checkAIStatus() {
      try {
        const response = await fetch('/admin/ai/status');
        const data = await response.json();
        if (data.enabled && data.configured) {
          document.getElementById('aiCard').style.display = 'block';
          document.querySelectorAll('.ai-field-btn').forEach(btn => btn.style.display = 'flex');
        }
      } catch (e) {
        console.log('IA não disponível');
      }
    }
    checkAIStatus();

    // Mostrar loading
    function showAILoading(message = 'Processando com IA...') {
      const overlay = document.createElement('div');
      overlay.className = 'ai-loading';
      overlay.id = 'aiLoadingOverlay';
      overlay.innerHTML = `<div class="ai-loading-content"><i class="bi bi-robot"></i><p>${message}</p></div>`;
      document.body.appendChild(overlay);
    }

    function hideAILoading() {
      const overlay = document.getElementById('aiLoadingOverlay');
      if (overlay) overlay.remove();
    }

    // Gerar matéria completa
    async function generateArticle() {
      const keyword = document.getElementById('aiKeyword').value.trim();
      if (!keyword) {
        alert('Digite uma palavra-chave ou tema.');
        return;
      }

      const searchWeb = document.getElementById('aiSearchWeb').checked;
      const style = document.getElementById('aiStyle').value;
      
showAILoading('Gerando matéria, aguarde...');

      try {
        const response = await fetch('/admin/ai/generate', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ keyword, searchWeb, style })
        });
        const data = await response.json();

        if (data.success && data.data) {
          document.getElementById('titleInput').value = data.data.title || '';
          document.getElementById('subtitleInput').value = data.data.subtitle || '';
          if (editorInstance && data.data.content) {
            editorInstance.setData(data.data.content);
          }
          alert('Matéria gerada com sucesso! Revise o conteúdo antes de publicar.');
        } else {
          alert('Erro: ' + (data.message || 'Não foi possível gerar a matéria.'));
        }
      } catch (error) {
        alert('Erro ao conectar com a IA: ' + error.message);
      } finally {
        hideAILoading();
      }
    }

    // Melhorar campo individual
    async function improveField(field) {
      let value, endpoint, title;
      
      if (field === 'title') {
        value = document.getElementById('titleInput').value.trim();
        if (!value) { alert('Digite um título primeiro.'); return; }
        endpoint = '/admin/ai/improve-title';
      } else if (field === 'subtitle') {
        value = document.getElementById('subtitleInput').value.trim();
        if (!value) { alert('Digite um subtítulo primeiro.'); return; }
        endpoint = '/admin/ai/improve-subtitle';
        title = document.getElementById('titleInput').value.trim();
      } else if (field === 'content') {
        value = editorInstance ? editorInstance.getData().trim() : '';
        if (!value) { alert('Escreva algum conteúdo primeiro.'); return; }
        endpoint = '/admin/ai/improve-content';
        title = document.getElementById('titleInput').value.trim();
      }

      showAILoading('Melhorando ' + (field === 'title' ? 'título' : field === 'subtitle' ? 'subtítulo' : 'conteúdo') + '...');

      try {
        const body = field === 'title' ? { title: value } : 
                     field === 'subtitle' ? { subtitle: value, title } : 
                     { content: value, title };

        const response = await fetch(endpoint, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(body)
        });
        const data = await response.json();

        if (data.success && data.data) {
          if (field === 'title') {
            document.getElementById('titleInput').value = data.data;
          } else if (field === 'subtitle') {
            document.getElementById('subtitleInput').value = data.data;
          } else if (field === 'content') {
            editorInstance.setData(data.data);
          }
        } else {
          alert('Erro: ' + (data.message || 'Não foi possível melhorar.'));
        }
      } catch (error) {
        alert('Erro: ' + error.message);
      } finally {
        hideAILoading();
      }
    }

    // ========================================
    // AUTO-SAVE LOCAL (Proteção contra queda)
    // ========================================
    const AUTO_SAVE_KEY = 'post_autosave_<%= isEdit && post ? post.id : "new" %>';
    const AUTO_SAVE_INTERVAL = 2000; // Salva a cada 2 segundos
    let autoSaveTimer = null;
    let lastSavedData = '';

    // Coletar dados do formulário
    function collectFormData() {
      return {
        title: document.getElementById('titleInput')?.value || '',
        subtitle: document.getElementById('subtitleInput')?.value || '',
        content: editorInstance ? editorInstance.getData() : '',
        category_id: document.querySelector('select[name="category_id"]')?.value || '',
        status: document.querySelector('input[name="status"]:checked')?.value || 'draft',
        slug: document.querySelector('input[name="slug"]')?.value || '',
        meta_title: document.querySelector('input[name="meta_title"]')?.value || '',
        meta_description: document.querySelector('textarea[name="meta_description"]')?.value || '',
        embed_code: document.querySelector('textarea[name="embed_code"]')?.value || '',
        savedAt: new Date().toISOString()
      };
    }

    // Salvar no localStorage (silencioso)
    function autoSaveToLocal() {
      try {
        const data = collectFormData();
        const dataStr = JSON.stringify(data);
        
        // Só salva se houver mudanças e conteúdo
        if (dataStr !== lastSavedData && (data.title || data.content)) {
          localStorage.setItem(AUTO_SAVE_KEY, dataStr);
          lastSavedData = dataStr;
        }
      } catch (e) {
        console.warn('Erro ao salvar rascunho local:', e);
      }
    }

    // Formatar tempo relativo
    function getTimeAgo(date) {
      const seconds = Math.floor((new Date() - date) / 1000);
      if (seconds < 60) return 'agora mesmo';
      if (seconds < 3600) return `há ${Math.floor(seconds / 60)} minuto(s)`;
      if (seconds < 86400) return `há ${Math.floor(seconds / 3600)} hora(s)`;
      return `há ${Math.floor(seconds / 86400)} dia(s)`;
    }

    // Mostrar modal bonito de restauração
    function showRestoreModal(data) {
      return new Promise((resolve) => {
        const savedDate = new Date(data.savedAt);
        const timeAgo = getTimeAgo(savedDate);
        const titlePreview = data.title || '(sem título)';
        const contentPreview = data.content ? data.content.replace(/<[^>]*>/g, '').substring(0, 100) + '...' : '';

        const modal = document.createElement('div');
        modal.id = 'restoreModal';
        modal.innerHTML = `
          <div style="position:fixed;inset:0;background:rgba(0,0,0,0.5);display:flex;align-items:center;justify-content:center;z-index:10000;animation:fadeIn 0.2s ease;">
            <div style="background:white;border-radius:16px;width:90%;max-width:420px;overflow:hidden;box-shadow:0 20px 60px rgba(0,0,0,0.3);animation:slideUp 0.3s ease;">
              <div style="background:linear-gradient(135deg,#6366f1,#8b5cf6);padding:24px;text-align:center;">
                <div style="width:60px;height:60px;background:rgba(255,255,255,0.2);border-radius:50%;display:flex;align-items:center;justify-content:center;margin:0 auto 12px;">
                  <i class="bi bi-file-earmark-text" style="font-size:28px;color:white;"></i>
                </div>
                <h3 style="color:white;margin:0;font-size:1.25rem;font-weight:600;">Rascunho Encontrado</h3>
                <p style="color:rgba(255,255,255,0.8);margin:8px 0 0;font-size:0.9rem;">Você tem um trabalho não salvo</p>
              </div>
              <div style="padding:20px;">
                <div style="background:#f8fafc;border-radius:10px;padding:14px;margin-bottom:16px;">
                  <div style="display:flex;align-items:center;gap:8px;margin-bottom:8px;">
                    <i class="bi bi-clock" style="color:#6366f1;"></i>
                    <span style="font-size:0.85rem;color:#64748b;">Salvo ${timeAgo}</span>
                  </div>
                  <p style="margin:0;font-weight:600;color:#1e293b;font-size:0.95rem;">${titlePreview}</p>
                  ${contentPreview ? `<p style="margin:8px 0 0;color:#64748b;font-size:0.8rem;line-height:1.4;">${contentPreview}</p>` : ''}
                </div>
                <div style="display:flex;gap:10px;">
                  <button id="btnDiscardDraft" style="flex:1;padding:12px;border:1.5px solid #e2e8f0;background:white;border-radius:10px;font-weight:500;cursor:pointer;color:#64748b;transition:all 0.2s;">
                    <i class="bi bi-trash3"></i> Descartar
                  </button>
                  <button id="btnRestoreDraft" style="flex:1;padding:12px;border:none;background:linear-gradient(135deg,#6366f1,#8b5cf6);border-radius:10px;font-weight:500;cursor:pointer;color:white;transition:all 0.2s;">
                    <i class="bi bi-arrow-counterclockwise"></i> Restaurar
                  </button>
                </div>
              </div>
            </div>
          </div>
          <style>
            @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
            @keyframes slideUp { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
            #btnDiscardDraft:hover { background: #f1f5f9; border-color: #cbd5e1; }
            #btnRestoreDraft:hover { transform: translateY(-2px); box-shadow: 0 4px 12px rgba(99,102,241,0.4); }
          </style>
        `;
        document.body.appendChild(modal);

        document.getElementById('btnRestoreDraft').onclick = () => {
          modal.remove();
          resolve(true);
        };
        document.getElementById('btnDiscardDraft').onclick = () => {
          modal.remove();
          resolve(false);
        };
      });
    }

    // Restaurar do localStorage
    async function restoreFromLocal() {
      try {
        const saved = localStorage.getItem(AUTO_SAVE_KEY);
        if (!saved) return false;
        
        const data = JSON.parse(saved);
        
        // Verifica se há conteúdo salvo
        if (!data.title && !data.content) {
          localStorage.removeItem(AUTO_SAVE_KEY);
          return false;
        }

        // Mostra modal bonito
        const restore = await showRestoreModal(data);

        if (restore) {
          if (data.title) document.getElementById('titleInput').value = data.title;
          if (data.subtitle) document.getElementById('subtitleInput').value = data.subtitle;
          if (data.content && editorInstance) {
            setTimeout(() => editorInstance.setData(data.content), 500);
          }
          if (data.category_id) {
            const catSelect = document.querySelector('select[name="category_id"]');
            if (catSelect) catSelect.value = data.category_id;
          }
          if (data.slug) {
            const slugInput = document.querySelector('input[name="slug"]');
            if (slugInput) slugInput.value = data.slug;
          }
          if (data.meta_title) {
            const metaTitle = document.querySelector('input[name="meta_title"]');
            if (metaTitle) metaTitle.value = data.meta_title;
          }
          if (data.meta_description) {
            const metaDesc = document.querySelector('textarea[name="meta_description"]');
            if (metaDesc) metaDesc.value = data.meta_description;
          }
          if (data.embed_code) {
            const embed = document.querySelector('textarea[name="embed_code"]');
            if (embed) embed.value = data.embed_code;
          }
          return true;
        } else {
          localStorage.removeItem(AUTO_SAVE_KEY);
        }
      } catch (e) {
        console.warn('Erro ao restaurar rascunho:', e);
      }
      return false;
    }

    // Limpar rascunho
    function clearAutoSave() {
      localStorage.removeItem(AUTO_SAVE_KEY);
    }

    // Iniciar auto-save
    function startAutoSave() {
      autoSaveTimer = setInterval(autoSaveToLocal, AUTO_SAVE_INTERVAL);
      
      window.addEventListener('beforeunload', () => autoSaveToLocal());
      
      window.addEventListener('offline', () => autoSaveToLocal());
    }

    // Limpar ao submeter formulário
    document.getElementById('postForm').addEventListener('submit', function() {
      clearAutoSave();
    });

    // Inicializar
    <% if (!isEdit) { %>
    setTimeout(async () => {
      await restoreFromLocal();
      startAutoSave();
    }, 1000);
    <% } else { %>
    startAutoSave();
    <% } %>
  </script>
</body>
</html>
