<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title><%= isEdit ? 'Editar Post' : 'Novo Post' %> - Admin</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.2/font/bootstrap-icons.css" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <style>
    :root { --primary: #3ba4ff; }
    * { font-family: 'Inter', sans-serif; }
    body { background: #f1f5f9; }
    .navbar { background: #fff; box-shadow: 0 1px 3px rgba(0,0,0,0.1); }
    .navbar-brand { font-weight: 700; color: var(--primary) !important; }
    .card { border: none; border-radius: 12px; box-shadow: 0 1px 3px rgba(0,0,0,0.08); }
    .card-header { background: #fff; border-bottom: 1px solid #e2e8f0; font-weight: 600; padding: 1rem 1.25rem; }
    .form-label { font-weight: 500; color: #374151; margin-bottom: 6px; }
    .form-control, .form-select { border-radius: 8px; border: 1px solid #d1d5db; padding: 10px 14px; }
    .form-control:focus, .form-select:focus { border-color: var(--primary); box-shadow: 0 0 0 3px rgba(59,164,255,0.15); }
    .btn-primary { background: var(--primary); border: none; border-radius: 8px; padding: 10px 20px; font-weight: 500; }
    .btn-primary:hover { background: #2b8ce6; }
    .btn-outline-secondary { border-radius: 8px; }
    .ck-editor__editable { min-height: 300px !important; }
    .img-preview { max-height: 150px; object-fit: cover; border-radius: 8px; }
  </style>
</head>
<body>
  <!-- Navbar -->
  <nav class="navbar navbar-expand-lg mb-4">
    <div class="container-fluid px-4">
      <a class="navbar-brand" href="/admin"><i class="bi bi-lightning-charge"></i> Portal Admin</a>
      <div class="d-flex align-items-center gap-3">
        <a href="/admin/posts" class="btn btn-outline-secondary btn-sm">
          <i class="bi bi-arrow-left me-1"></i>Voltar
        </a>
        <a href="/" target="_blank" class="btn btn-outline-secondary btn-sm">
          <i class="bi bi-box-arrow-up-right me-1"></i>Ver Site
        </a>
      </div>
    </div>
  </nav>

  <div class="container-fluid px-4 pb-5">
    <form id="postForm" action="<%= isEdit ? '/admin/posts/' + post.id : '/admin/posts' %>" method="POST" enctype="multipart/form-data">
      <div class="row g-4">
        <!-- Conte√∫do Principal -->
        <div class="col-lg-8">
          <!-- T√≠tulo -->
          <div class="card mb-4">
            <div class="card-body">
              <div class="mb-3">
                <label class="form-label">T√≠tulo <span class="text-danger">*</span></label>
                <input type="text" name="title" class="form-control form-control-lg" 
                       value="<%= post ? post.title : '' %>" required 
                       placeholder="Digite o t√≠tulo do post" style="font-weight: 600;">
              </div>
              <div>
                <label class="form-label">Subt√≠tulo</label>
                <input type="text" name="subtitle" class="form-control" 
                       value="<%= post ? (post.subtitle || '') : '' %>" 
                       placeholder="Subt√≠tulo ou resumo curto (opcional)">
              </div>
            </div>
          </div>

          <!-- Editor de Conte√∫do -->
          <div class="card mb-4">
            <div class="card-header">
              <i class="bi bi-pencil-square me-2"></i>Conte√∫do
            </div>
            <div class="card-body">
              <textarea name="content" id="editor"><%= post ? post.content : '' %></textarea>
              <input type="hidden" name="content_backup" id="contentBackup">
            </div>
          </div>

          <!-- SEO (Colaps√°vel) -->
          <div class="card">
            <div class="card-header" data-bs-toggle="collapse" data-bs-target="#seoSection" style="cursor: pointer;">
              <i class="bi bi-search me-2"></i>SEO <small class="text-muted ms-2">(opcional)</small>
              <i class="bi bi-chevron-down float-end"></i>
            </div>
            <div class="collapse" id="seoSection">
              <div class="card-body">
                <div class="mb-3">
                  <label class="form-label">Slug (URL)</label>
                  <div class="input-group">
                    <span class="input-group-text">/noticia/</span>
                    <input type="text" name="slug" class="form-control" 
                           value="<%= post ? post.slug : '' %>" placeholder="url-amigavel">
                  </div>
                  <small class="text-muted">Deixe em branco para gerar automaticamente</small>
                </div>
                <div class="mb-3">
                  <label class="form-label">Meta T√≠tulo</label>
                  <input type="text" name="meta_title" class="form-control" 
                         value="<%= post ? (post.meta_title || '') : '' %>" 
                         maxlength="70" placeholder="T√≠tulo para SEO (m√°x. 70 caracteres)">
                </div>
                <div>
                  <label class="form-label">Meta Descri√ß√£o</label>
                  <textarea name="meta_description" class="form-control" rows="2" 
                            maxlength="160" placeholder="Descri√ß√£o para SEO (m√°x. 160 caracteres)"><%= post ? (post.meta_description || '') : '' %></textarea>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Sidebar -->
        <div class="col-lg-4">
          <!-- Publicar -->
          <div class="card mb-4">
            <div class="card-header">
              <i class="bi bi-send me-2"></i>Publicar
            </div>
            <div class="card-body">
              <div class="mb-3">
                <label class="form-label">Status</label>
                <select name="status" class="form-select">
                  <option value="draft" <%= post && post.status === 'draft' ? 'selected' : '' %>>üìù Rascunho</option>
                  <option value="published" <%= post && post.status === 'published' ? 'selected' : '' %>>‚úÖ Publicado</option>
                  <option value="scheduled" <%= post && post.status === 'scheduled' ? 'selected' : '' %>>üìÖ Agendado</option>
                </select>
              </div>
              
              <div class="mb-3">
                <label class="form-label">Agendar para</label>
                <input type="datetime-local" name="scheduled_at" class="form-control" 
                       value="<%= post && post.scheduled_at ? new Date(post.scheduled_at).toISOString().slice(0,16) : '' %>">
              </div>
              
              <div class="form-check mb-3">
                <input type="checkbox" name="featured" class="form-check-input" id="featured" <%= post && post.featured ? 'checked' : '' %>>
                <label class="form-check-label" for="featured">
                  <i class="bi bi-star-fill text-warning me-1"></i>Destaque na Home
                </label>
              </div>
              
              <div class="d-grid gap-2">
                <button type="submit" class="btn btn-primary btn-lg">
                  <i class="bi bi-check-lg me-1"></i><%= isEdit ? 'Atualizar Post' : 'Publicar Post' %>
                </button>
                <% if (isEdit) { %>
                  <a href="/noticia/<%= post.slug %>" target="_blank" class="btn btn-outline-secondary">
                    <i class="bi bi-eye me-1"></i>Visualizar
                  </a>
                <% } %>
              </div>
            </div>
          </div>

          <!-- Categoria -->
          <div class="card mb-4">
            <div class="card-header">
              <i class="bi bi-folder me-2"></i>Categoria
            </div>
            <div class="card-body">
              <select name="category_id" class="form-select">
                <option value="">Sem categoria</option>
                <% categories.forEach(cat => { %>
                  <option value="<%= cat.id %>" <%= post && post.category_id == cat.id ? 'selected' : '' %>><%= cat.name %></option>
                <% }) %>
              </select>
            </div>
          </div>

          <!-- Tags -->
          <div class="card mb-4">
            <div class="card-header">
              <i class="bi bi-tags me-2"></i>Tags
            </div>
            <div class="card-body">
              <input type="text" name="tags" class="form-control" 
                     value="<%= post && post.tags ? (Array.isArray(post.tags) ? post.tags.join(', ') : post.tags) : '' %>" 
                     placeholder="tag1, tag2, tag3">
              <small class="text-muted">Separe por v√≠rgula</small>
            </div>
          </div>

          <!-- Imagem Destacada -->
          <div class="card">
            <div class="card-header">
              <i class="bi bi-image me-2"></i>Imagem Destacada
            </div>
            <div class="card-body">
              <% if (post && post.featured_image) { %>
                <div class="mb-3">
                  <img src="<%= post.featured_image %>" alt="" class="img-fluid img-preview w-100">
                </div>
              <% } %>
              <input type="file" name="featured_image" class="form-control" accept="image/*" id="imageInput">
              <div id="imagePreview" class="mt-2"></div>
              <small class="text-muted">JPG, PNG, GIF, WebP (m√°x. 10MB)</small>
            </div>
          </div>
        </div>
      </div>
    </form>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://cdn.ckeditor.com/ckeditor5/40.1.0/classic/ckeditor.js"></script>
  <script>
    let editorInstance;
    
    // Inicializar CKEditor
    ClassicEditor
      .create(document.querySelector('#editor'), {
        toolbar: ['heading', '|', 'bold', 'italic', 'link', '|', 'bulletedList', 'numberedList', '|', 'blockQuote', 'undo', 'redo'],
        placeholder: 'Escreva o conte√∫do do seu post aqui...'
      })
      .then(editor => {
        editorInstance = editor;
      })
      .catch(error => console.error(error));

    // Validar formul√°rio antes de enviar
    document.getElementById('postForm').addEventListener('submit', function(e) {
      const title = document.querySelector('input[name="title"]').value.trim();
      const content = editorInstance ? editorInstance.getData().trim() : '';
      
      if (!title) {
        e.preventDefault();
        alert('Por favor, preencha o t√≠tulo do post.');
        return false;
      }
      
      if (!content) {
        e.preventDefault();
        alert('Por favor, preencha o conte√∫do do post.');
        return false;
      }
      
      // Atualizar o textarea hidden com o conte√∫do do editor
      document.getElementById('contentBackup').value = content;
      return true;
    });

    // Preview de imagem
    document.getElementById('imageInput').addEventListener('change', function(e) {
      const file = e.target.files[0];
      if (file) {
        const reader = new FileReader();
        reader.onload = function(e) {
          document.getElementById('imagePreview').innerHTML = 
            '<img src="' + e.target.result + '" class="img-fluid img-preview w-100 mt-2">';
        };
        reader.readAsDataURL(file);
      }
    });
  </script>
</body>
</html>
